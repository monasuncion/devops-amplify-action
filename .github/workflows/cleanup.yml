name: Deploy Amplify Environment

on:
  workflow_call:
    inputs:
      AWS_REGION: 
        required: false
        type: string
        default: 'ap-southeast-1'
      AMPLIFY_DOMAIN:
        required: false
        type: string
        default: ''
    secrets:
      AMPLIFY_TOKEN:
        required: true
      ROLE_TO_ASSUME: 
        required: true

jobs:
  amplify:
    name: Deploy to Amplify Console
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      id: creds
      uses: aws-actions/configure-aws-credentials@master
      with:
        role-to-assume: ${{ secrets.ROLE_TO_ASSUME }}
        aws-region:  ${{ inputs.AWS_REGION }}

    - name: Configure environment name
      id: env-name
      env:
        REPO: ${{ github.repository }}
      run: |
        BRANCH=`sed -e 's#.*\/\(\)#\1#' <<< $GITHUB_REF`
        PROJECT=`sed -e 's#.*\/\(\)#\1#' <<< $GITHUB_REPOSITORY`
        ENVIRONMENT=$PROJECT-$BRANCH
        PARAMETER_PREFIX="/$BRANCH/$PROJECT"
        echo "Environment name: $ENVIRONMENT"
        echo "Project name: $PROJECT"
        echo "::set-output name=environment::$ENVIRONMENT"
        echo "::set-output name=project::$PROJECT"
        echo "::set-output name=branch::$BRANCH"
        echo "::set-output name=prameterPrefix::$PARAMETER_PREFIX"

    - name: Delete Amplify Cloudformation Stack 
      id: amplify-stack
      env:
        stackName: ${{ steps.env-name.outputs.environment }}
      run: |
        aws cloudformation delete-stack $stackName

    - name: Amplify App Secrets
      env:
        EnvironmentName: ${{ steps.env-name.outputs.environment }}
        PARAM_PREFIX: ${{ steps.env-name.outputs.prameterPrefix }}
        BRANCH: ${{ steps.env-name.outputs.branch }}
        PROJECT: ${{ steps.env-name.outputs.project }}
      run: |
        export AMPLIFY_ID=$(aws amplify list-apps --out json | jq -r '.apps[] | select(.name=="'$EnvironmentName'") | .appId')
        
        if [ $BRANCH == "master" ] 
        then
          PARAM_PREFIX="/production/$AMPLIFY_ID"
        else
          PARAM_PREFIX="/develop/$AMPLIFY_ID"
        fi
        
        secrets=$(aws ssm describe-parameters --parameter-filters Key=Name,Option=BeginsWith,Values=$PARAM_PREFIX | jq -r '.Parameters[] | .Name')
        backend_environments=$(aws amplify list-backend-environments --app-id $AMPLIFY_ID | jq -r .backendEnvironments[] | jq -r .environmentName)

        secrets_list=(`echo $secrets | sed 's/" "/\n/g'`)
        backend_environment_list=(`echo $backend_environments | sed 's/" "/\n/g'`)

        for secret in "${secrets_list[@]}"
        do
            secrets_value=$(aws ssm get-parameter --name $secret --with-decryption | jq -r '.Parameter | .Value')
            parameter_name=$(echo $secret | sed -e 's/\/.*\///g')

            for backend in "${backend_environment_list[@]}"
            do  
                echo "Deleting /amplify/$AMPLIFY_ID/$backend/$parameter_name"
                aws ssm delete-parameter --name "/amplify/$AMPLIFY_ID/$backend/$parameter_name"
            done
        done
      shell: bash

    